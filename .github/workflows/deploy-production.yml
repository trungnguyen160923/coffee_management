name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng

# Permissions for GitHub Container Registry
permissions:
  contents: read
  packages: write

env:
  # S·ª≠ d·ª•ng GitHub Container Registry (GHCR)
  REGISTRY: ghcr.io
  # Format: ghcr.io/OWNER/IMAGE_NAME
  # OWNER l√† GitHub username ho·∫∑c organization name

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build v√† push Backend Services
      - name: Build and push API Gateway
        uses: docker/build-push-action@v5
        with:
          context: ./api-gateway
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-api-gateway:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-api-gateway:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-api-gateway:latest
          cache-to: type=inline

      - name: Build and push Auth Service
        uses: docker/build-push-action@v5
        with:
          context: ./auth
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-auth:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-auth:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-auth:latest
          cache-to: type=inline

      - name: Build and push Catalog Service
        uses: docker/build-push-action@v5
        with:
          context: ./catalog-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-catalog:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-catalog:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-catalog:latest
          cache-to: type=inline

      - name: Build and push Order Service
        uses: docker/build-push-action@v5
        with:
          context: ./order-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-order:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-order:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-order:latest
          cache-to: type=inline

      - name: Build and push Profile Service
        uses: docker/build-push-action@v5
        with:
          context: ./profile-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-profile:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-profile:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-profile:latest
          cache-to: type=inline

      - name: Build and push Notification Service
        uses: docker/build-push-action@v5
        with:
          context: ./notification-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-notification:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-notification:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-notification:latest
          cache-to: type=inline

      # Build v√† push AI Service
      - name: Build and push AI Service
        uses: docker/build-push-action@v5
        with:
          context: ./ai-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-ai-service:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-ai-service:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-ai-service:latest
          cache-to: type=inline

      # Build v√† push Frontend Admin (v·ªõi build args)
      - name: Build and push Frontend Admin
        uses: docker/build-push-action@v5
        with:
          context: ./fe_coffee_manager
          push: true
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
            VITE_AI_SERVICE_URL=${{ secrets.VITE_AI_SERVICE_URL }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-frontend-admin:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-frontend-admin:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-frontend-admin:latest
          cache-to: type=inline

      # Build v√† push Frontend Customer (v·ªõi build args)
      - name: Build and push Frontend Customer
        uses: docker/build-push-action@v5
        with:
          context: ./web-app
          push: true
          build-args: |
            REACT_APP_API_GATEWAY=${{ secrets.REACT_APP_API_GATEWAY }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-frontend-customer:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-frontend-customer:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/coffee-frontend-customer:latest
          cache-to: type=inline

  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Prepare server directory
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'ENDSSH'
            # Project directory
            PROJECT_DIR="/opt/coffee_management"
            
            # Create project directory if it doesn't exist
            sudo mkdir -p "$PROJECT_DIR"
            sudo mkdir -p "$PROJECT_DIR/scripts"
            sudo mkdir -p "$PROJECT_DIR/mysql-conf"
            
            # Set ownership (adjust user if needed)
            sudo chown -R $USER:$USER "$PROJECT_DIR" || sudo chown -R $(whoami):$(whoami) "$PROJECT_DIR"
            
            echo "‚úÖ Server directory prepared: $PROJECT_DIR"
          ENDSSH

      - name: Copy deployment files to server
        run: |
          PROJECT_DIR="/opt/coffee_management"
          echo "Using project directory: $PROJECT_DIR"
          
          # Copy docker-compose files
          scp docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$PROJECT_DIR/ || echo "Warning: docker-compose.prod.yml copy failed"
          scp docker-compose.prod.registry.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$PROJECT_DIR/ || echo "Warning: docker-compose.prod.registry.yml copy failed"
          
          # Copy scripts directory
          scp -r scripts/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$PROJECT_DIR/ || echo "Warning: scripts copy failed"
          
          # Copy mysql-conf directory
          scp -r mysql-conf/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$PROJECT_DIR/ || echo "Warning: mysql-conf copy failed"
          
          echo "‚úÖ Files copied to server"

      - name: Deploy on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'ENDSSH'
            set -e  # Exit on error
            
            echo "=========================================="
            echo "Starting Deployment"
            echo "=========================================="
            
            # Project directory
            PROJECT_DIR="/opt/coffee_management"
            
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå ERROR: Directory $PROJECT_DIR does not exist!"
              echo "Please ensure the directory was created in previous step."
              exit 1
            fi
            
            cd "$PROJECT_DIR"
            echo "‚úÖ Current directory: $(pwd)"
            
            # Check if .env.prod exists
            if [ ! -f ".env.prod" ]; then
              echo "‚ùå ERROR: .env.prod file not found!"
              echo "Please create .env.prod file on the server:"
              echo "  cd $PROJECT_DIR"
              echo "  cp env.prod.example .env.prod"
              echo "  nano .env.prod  # Fill in real values"
              exit 1
            fi
            echo "‚úÖ Found .env.prod file"
            
            # Set registry prefix (GHCR format: ghcr.io/OWNER)
            export REGISTRY_PREFIX=${{ env.REGISTRY }}/${{ github.repository_owner }}
            echo "Registry prefix: $REGISTRY_PREFIX"
            
            # Login to GHCR if repo is private (optional - only needed for private repos)
            # If images are public, this step can be skipped
            if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "Logging in to GHCR..."
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
              echo "‚úÖ Logged in to GHCR"
            else
              echo "‚ÑπÔ∏è  No GHCR_TOKEN provided, assuming public images"
            fi
            
            # Use registry-based compose file (preferred for CI/CD)
            COMPOSE_FILE="docker-compose.prod.registry.yml"
            if [ ! -f "$COMPOSE_FILE" ]; then
              echo "‚ö†Ô∏è  Warning: docker-compose.prod.registry.yml not found, using docker-compose.prod.yml"
              COMPOSE_FILE="docker-compose.prod.yml"
            fi
            
            if [ ! -f "$COMPOSE_FILE" ]; then
              echo "‚ùå ERROR: Neither docker-compose.prod.registry.yml nor docker-compose.prod.yml found!"
              echo "Available files:"
              ls -la *.yml *.yaml 2>/dev/null || echo "No yml/yaml files found"
              echo "Current directory: $(pwd)"
              echo "Looking for: $COMPOSE_FILE"
              exit 1
            fi
            echo "‚úÖ Using compose file: $COMPOSE_FILE"
            
            # Pull latest images
            echo ""
            echo "=== Pulling latest images ==="
            REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod pull || {
              echo "‚ùå ERROR: Failed to pull images"
              exit 1
            }
            echo "‚úÖ Images pulled successfully"
            
            # Run database migrations if needed
            if [ -f scripts/run-migration.sh ]; then
              chmod +x scripts/run-migration.sh
              # Uncomment v√† ch·∫°y migration n·∫øu c·∫ßn
              # ./scripts/run-migration.sh profile-service/migrations/remove_role_id_from_shift_assignments.sql profile_db
            fi
            
            # Stop old containers
            echo ""
            echo "=== Stopping old containers ==="
            REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod down --timeout 30 || true
            
            # Start new containers
            echo ""
            echo "=== Starting new containers ==="
            REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod up -d || {
              echo "‚ùå ERROR: Failed to start containers"
              echo "Checking logs..."
              REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE logs --tail=50
              exit 1
            }
            echo "‚úÖ Containers started"
            
            # Clean up old images
            echo ""
            echo "=== Cleaning up old images ==="
            docker image prune -f || true
            
            # Wait for services to initialize
            echo ""
            echo "=== Waiting for services to initialize (30 seconds) ==="
            sleep 30
            
            # Show container status
            echo ""
            echo "=== Container Status ==="
            REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE ps
            
            echo ""
            echo "=========================================="
            echo "‚úÖ Deployment completed successfully!"
            echo "=========================================="
          ENDSSH

      - name: Health Check
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'ENDSSH'
            set -e  # Exit on error
            
            # Project directory
            PROJECT_DIR="/opt/coffee_management"
            
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå ERROR: Directory $PROJECT_DIR does not exist!"
              exit 1
            fi
            
            cd "$PROJECT_DIR"
            
            # Set registry prefix
            export REGISTRY_PREFIX=${{ env.REGISTRY }}/${{ github.repository_owner }}
            
            # Use registry-based compose file
            COMPOSE_FILE="docker-compose.prod.registry.yml"
            if [ ! -f "$COMPOSE_FILE" ]; then
              COMPOSE_FILE="docker-compose.prod.yml"
            fi
            
            echo "=========================================="
            echo "Starting Health Checks"
            echo "=========================================="
            echo "Compose file: $COMPOSE_FILE"
            echo "Registry prefix: $REGISTRY_PREFIX"
            echo "=========================================="
            
            # Wait a bit more for services to be ready
            echo "Waiting for services to be ready (120 seconds)..."
            sleep 120
            
            # Check if services are running
            echo ""
            echo "=== Container Status ==="
            REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod ps
            
            # Check for failed containers
            echo ""
            echo "=== Checking for Failed Containers ==="
            FAILED_CONTAINERS=$(REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod ps --filter "status=exited" --format "{{.Name}}" || true)
            if [ -n "$FAILED_CONTAINERS" ]; then
              echo "‚ùå ERROR: Some containers failed to start:"
              echo "$FAILED_CONTAINERS"
              echo ""
              echo "=== Logs of Failed Containers ==="
              REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod logs --tail=50
              exit 1
            fi
            
            # Check for restarting containers
            RESTARTING_CONTAINERS=$(REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod ps --filter "status=restarting" --format "{{.Name}}" || true)
            if [ -n "$RESTARTING_CONTAINERS" ]; then
              echo "‚ö†Ô∏è  WARNING: Some containers are restarting:"
              echo "$RESTARTING_CONTAINERS"
            fi
            
            # Health checks
            echo ""
            echo "=== Performing Health Checks ==="
            
            # Function to check health with retry and timeout
            check_health() {
              local service_name=$1
              local url=$2
              local max_retries=${3:-8}  # Default 8 retries, can be overridden
              local wait_time=${4:-15}  # Default 15 seconds, can be overridden
              local retry_count=0
              
              echo "üîç Checking $service_name at $url..."
              
              while [ $retry_count -lt $max_retries ]; do
                # Use curl with timeout (15 seconds) and follow redirects
                if curl -f --max-time 15 --connect-timeout 8 "$url" > /dev/null 2>&1; then
                  echo "‚úÖ $service_name is healthy"
                  return 0
                else
                  retry_count=$((retry_count + 1))
                  if [ $retry_count -lt $max_retries ]; then
                    echo "‚è≥ $service_name not ready yet, retrying... ($retry_count/$max_retries) - waiting ${wait_time}s"
                    sleep $wait_time
                  fi
                fi
              done
              
              echo "‚ùå $service_name health check failed after $max_retries attempts"
              echo "   URL: $url"
              echo "   Trying to get more info..."
              curl -v --max-time 15 "$url" 2>&1 | head -20 || true
              return 1
            }
            
            # Critical Services - Must pass
            echo ""
            echo "=== Critical Services Health Checks ==="
            
            # Check API Gateway (direct access) - may need more time to start
            if ! check_health "API Gateway (Direct)" "http://localhost:8000/actuator/health" 10 20; then
              echo ""
              echo "=== API Gateway Logs (last 30 lines) ==="
              REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod logs --tail=30 api-gateway || true
              exit 1
            fi
            sleep 3  # Small delay between checks
            
            # Check Auth Service (direct access)
            if ! check_health "Auth Service (Direct)" "http://localhost:8001/auth-service/actuator/health" 10 18; then
              echo ""
              echo "=== Auth Service Logs (last 30 lines) ==="
              REGISTRY_PREFIX=$REGISTRY_PREFIX docker compose -f $COMPOSE_FILE --env-file .env.prod logs --tail=30 auth-service || true
              exit 1
            fi
            sleep 3  # Small delay between checks
            
            # Check Auth Service via API Gateway (test routing)
            check_health "Auth Service (via Gateway)" "http://localhost:8000/api/auth-service/actuator/health" 8 15 || exit 1
            sleep 3  # Small delay between checks
            
            # Important Services - Should pass
            echo ""
            echo "=== Important Services Health Checks ==="
            
            # Check Order Service (direct access)
            check_health "Order Service (Direct)" "http://localhost:8002/order-service/actuator/health" 10 18 || exit 1
            sleep 3  # Small delay between checks
            
            # Check Order Service via API Gateway
            check_health "Order Service (via Gateway)" "http://localhost:8000/api/order-service/actuator/health" 8 15 || exit 1
            sleep 3  # Small delay between checks
            
            # Check Catalog Service (direct access)
            check_health "Catalog Service (Direct)" "http://localhost:8004/catalogs/actuator/health" 10 18 || exit 1
            sleep 3  # Small delay between checks
            
            # Check Catalog Service via API Gateway
            check_health "Catalog Service (via Gateway)" "http://localhost:8000/api/catalogs/actuator/health" 8 15 || exit 1
            sleep 3  # Small delay between checks
            
            # Optional Services - Nice to have
            echo ""
            echo "=== Optional Services Health Checks ==="
            
            # Check Profile Service (direct access)
            check_health "Profile Service (Direct)" "http://localhost:8003/profiles/actuator/health" 8 15 || true
            sleep 2  # Small delay between checks
            
            # Check Profile Service via API Gateway
            check_health "Profile Service (via Gateway)" "http://localhost:8000/api/profiles/actuator/health" 8 15 || true
            sleep 2  # Small delay between checks
            
            # Check Notification Service (direct access)
            check_health "Notification Service (Direct)" "http://localhost:8006/notification-service/actuator/health" 8 15 || true
            sleep 2  # Small delay between checks
            
            # Check Notification Service via API Gateway
            check_health "Notification Service (via Gateway)" "http://localhost:8000/api/notification-service/actuator/health" 8 15 || true
            sleep 2  # Small delay between checks
            
            # Check AI Service (direct access - custom endpoint)
            check_health "AI Service (Direct)" "http://localhost:8005/health" 8 15 || true
            sleep 2  # Small delay between checks
            
            # Check AI Service via API Gateway
            check_health "AI Service (via Gateway)" "http://localhost:8000/api/ai/health" 8 15 || true
            
            echo ""
            echo "=========================================="
            echo "‚úÖ All Critical Health Checks Passed!"
            echo "=========================================="
          ENDSSH

