server:
  port: ${SERVER_PORT:8000}

app:
  api-prefix: ${API_PREFIX:/api}

# Gateway codec configuration for file uploads
# This allows handling larger file uploads (up to 15MB) for catalog service
# The buffer is only allocated when needed, so it won't affect other routes
gateway:
  codec:
    max-in-memory-size: ${GATEWAY_CODEC_MAX_IN_MEMORY_SIZE:15728640} # 15MB in bytes

spring:
  config:
    import: optional:file:.env[.properties]
  application:
    name: api-gateway
  webflux:
    static-path-pattern: /static/**
  cloud:
    gateway:
      server:
        webflux:
          routes:
          - id: auth_service
            uri: ${AUTH_SERVICE_URL:http://localhost:8001}
            predicates:
              - Path=${app.api-prefix}/auth-service/**
            filters:
              - StripPrefix=1
          - id: profile_service
            uri: ${PROFILE_SERVICE_URL:http://localhost:8003}
            predicates:
              - Path=${app.api-prefix}/profiles/**
            filters:
              - StripPrefix=1
          - id: order_service
            uri: ${ORDER_SERVICE_URL:http://localhost:8002}
            predicates:
              - Path=${app.api-prefix}/order-service/**
            filters:
              - StripPrefix=1
          - id: catalog_service
            uri: ${CATALOG_SERVICE_URL:http://localhost:8004}
            predicates:
              - Path=${app.api-prefix}/catalogs/**
            filters:
              - StripPrefix=1
              - RewritePath=/api/catalogs/(?<path>.*), /catalogs/$\{path}
          - id: notification_service
            uri: ${NOTIFICATION_HTTP_URL:http://localhost:8006}
            predicates:
              - Path=${app.api-prefix}/notification-service/**
            filters:
              - StripPrefix=1
          # HTTP route for SockJS HTTP requests (GET /ws/info, /ws/xhr, etc.)
          - id: notification_service_ws_http
            uri: ${NOTIFICATION_HTTP_URL:http://localhost:8006}
            predicates:
              - Path=${app.api-prefix}/notification-service/ws/**
              # Exclude WebSocket upgrade requests
              - Header=!Upgrade, websocket
            filters:
              # Strip /api/notification-service, leaving /ws/**
              # With context-path /notification-service, Spring Security will match /ws/**
              - StripPrefix=2
          # WebSocket route for actual WebSocket connections
          - id: notification_service_ws
            uri: ${NOTIFICATION_WS_URL:ws://localhost:8006}
            predicates:
              - Path=${app.api-prefix}/notification-service/ws/**
              # Only match WebSocket upgrade requests
              - Header=Upgrade, websocket
            filters:
              # Strip /api/notification-service, leaving /ws/**
              - StripPrefix=2
          - id: ai_service
            uri: ${AI_SERVICE_URL:http://localhost:8005}
            predicates:
              - Path=${app.api-prefix}/ai/**
          - id: fallback_route
            uri: http://localhost:${SERVER_PORT:8000}
            predicates:
              - Path=/**
            filters:
              - RewritePath=/.*, /api/fallback
    default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin, Access-Control-Allow-Credentials, Access-Control-Allow-Methods, Access-Control-Allow-Headers, RETAIN_UNIQUE
  # kafka:
  #   bootstrap-servers: localhost:9094
  #   consumer:
  #     group-id: api-gateway-group
  #     auto-offset-reset: earliest
  #     key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
  #     value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
  #     properties:
  #       spring.deserializer.value.delegate.class: org.springframework.kafka.support.serializer.JsonDeserializer
  #       spring.json.trusted.packages: "com.caffee_management.api_gateway.events"
  #       spring.json.value.default.type: com.caffee_management.api_gateway.events.ProfileCreatedEvent
  #   producer:
  #     key-serializer: org.apache.kafka.common.serialization.StringSerializer
  #     value-serializer: org.springframework.kafka.support.serializer.JsonSerializer